<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Zeitlinie</title>

<style>
  body {
    margin: 0;
    background: white;
    font-family: Arial, sans-serif;
    overflow-x: scroll;
    overflow-y: hidden;
  }

  #wrapper {
    position: relative;
    width: 100000px;
    height: 100vh;
  }

  #timeline {
    position: absolute;
    top: 50%;
    left: 0;
    width: 100%;
    height: 2px;
    background: black;
    cursor: pointer;
  }

  .marker {
    position: absolute;
    width: 2px;
    height: 30px;
    background: black;
    top: calc(50% - 15px);
    cursor: move;
  }

  .label {
    position: absolute;
    background: white;
    font-size: 14px;
    padding: 4px;
    border: none;
    outline: none;
    cursor: move;
  }

  .editing {
    border: 1px solid black;
    cursor: text;
  }
</style>
</head>

<body>
<div id="wrapper">
  <div id="timeline"></div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// -------- Firebase Setup --------
const firebaseConfig = {
  apiKey: "AIzaSyDXXye7tWCW4VT1SOBjVxgYqWHyOJIDT8Y",
  authDomain: "aeternum-chronoverse.firebaseapp.com",
  databaseURL: "https://aeternum-chronoverse-default-rtdb.firebaseio.com",
  projectId: "aeternum-chronoverse",
  storageBucket: "aeternum-chronoverse.firebasestorage.app",
  messagingSenderId: "606280452565",
  appId: "1:606280452565:web:4e1dc2a0f3ef231ba2d55c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// -------- Timeline Daten --------
let data = []; // initial leer

const wrapper = document.getElementById("wrapper");
const timeline = document.getElementById("timeline");

// -------- Speichern in Firebase + lokal --------
function save() {
  localStorage.setItem("timelineData", JSON.stringify(data));
  db.ref('timeline').set(data);
}

// -------- Daten aus Firebase laden --------
db.ref('timeline').on('value', snapshot => {
  const firebaseData = snapshot.val();
  if(firebaseData) {
    data = firebaseData;
    render();
  } else {
    const localData = JSON.parse(localStorage.getItem("timelineData")) || [];
    data = localData;
    render();
  }
});

// -------- Render Funktion --------
function render() {
  document.querySelectorAll(".marker, .label").forEach(e => e.remove());

  data.forEach((item, index) => {
    const marker = document.createElement("div");
    marker.className = "marker";
    marker.style.left = item.x + "px";

    const label = document.createElement("div");
    label.className = "label";
    label.contentEditable = false;
    label.innerText = item.text;
    label.style.left = (item.x + 5) + "px";
    label.style.top = item.y + "px";

    // ---- Editieren ----
    label.addEventListener("click", e => {
      e.stopPropagation();
      label.contentEditable = true;
      label.classList.add("editing");
      label.focus();
    });

    label.addEventListener("keydown", e => {
      let y = parseInt(label.style.top);
      if(e.key==="Enter"){ e.preventDefault(); y-=20; }
      if(e.key==="ArrowUp"){ e.preventDefault(); y-=5; }
      if(e.key==="ArrowDown"){ e.preventDefault(); y+=5; }
      label.style.top = y + "px";
      data[index].y = y;
    });

    label.addEventListener("blur", () => {
      label.contentEditable = false;
      label.classList.remove("editing");
      data[index].text = label.innerText;
      save();
    });

    // ---- Marker verschiebbar ----
    let dragMarker = false, offsetX=0, offsetY=0;
    marker.addEventListener("mousedown", e => {
      dragMarker = true;
      offsetX = e.clientX - marker.offsetLeft;
      offsetY = e.clientY - parseInt(label.style.top);
    });

    document.addEventListener("mousemove", e => {
      if(!dragMarker) return;
      let idx = Array.from(wrapper.querySelectorAll(".marker")).indexOf(marker);
      let newX = e.clientX - offsetX;
      let newY = e.clientY - offsetY;
      marker.style.left = newX + "px";
      label.style.left = (newX+5) + "px";
      label.style.top = newY + "px";
      data[idx].x = newX;
      data[idx].y = newY;
    });

    document.addEventListener("mouseup", e => {
      if(dragMarker){
        save();
        dragMarker=false;
      }
    });

    // ---- Label verschiebbar vertikal ----
    let dragging=false, offsetLabelY=0;
    label.addEventListener("mousedown", e=>{
      dragging=true; offsetLabelY = e.clientY - label.offsetTop;
    });
    document.addEventListener("mousemove", e=>{
      if(!dragging) return;
      let y = e.clientY - offsetLabelY;
      label.style.top = y + "px";
      data[index].y = y;
    });
    document.addEventListener("mouseup", ()=>{
      if(dragging){ dragging=false; save(); }
    });

    // ---- Marker lÃ¶schen (Rechtsklick) ----
    marker.addEventListener("contextmenu", e=>{
      e.preventDefault();
      let idx = Array.from(wrapper.querySelectorAll(".marker")).indexOf(marker);
      data.splice(idx,1);
      save();
      render();
    });

    label.addEventListener("contextmenu", e=>{
      e.preventDefault();
      let idx = Array.from(wrapper.querySelectorAll(".label")).indexOf(label);
      data.splice(idx,1);
      save();
      render();
    });

    wrapper.appendChild(marker);
    wrapper.appendChild(label);
  });
}

// ---- Klick auf Timeline ----
timeline.addEventListener("click", e=>{
  const x = e.clientX + window.scrollX;
  const y = window.innerHeight/2 - 60;
  data.push({x:x, y:y, text:"Text eingeben"});
  save();
  render();

  const labels = document.querySelectorAll(".label");
  const last = labels[labels.length-1];
  last.click();
});

// ---- Start ----
render();
</script>

</body>
</html>
